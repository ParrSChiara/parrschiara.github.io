<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Foglio Settimanale - GitHub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .config-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #555;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #f0f4ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f8f9ff;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-selected {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .file-selected.show {
            display: block;
        }

        .help-link {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
        }

        .help-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üìÑ Foglio Settimanale - GitHub</h1>
    <p class="subtitle">Carica e publica automaticamente su GitHub</p>

    <div id="statusMessage" class="status-message"></div>

    <div class="config-section">
        <h3>‚öôÔ∏è Configurazione GitHub</h3>

        <div class="form-group">
            <label for="repoOwner">Username/Organizzazione GitHub</label>
            <input type="text" id="repoOwner" placeholder="es: tuousername">
            <div class="hint">Il proprietario del repository</div>
        </div>

        <div class="form-group">
            <label for="repoName">Nome Repository</label>
            <input type="text" id="repoName" placeholder="es: foglio-settimanale">
            <div class="hint">Il nome del repository dove caricare il file</div>
        </div>

        <div class="form-group">
            <label for="githubToken">GitHub Personal Access Token</label>
            <input type="password" id="githubToken" placeholder="ghp_...">
            <div class="hint">
                <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="help-link">
                    Crea un token con permessi "repo"
                </a>
            </div>
        </div>

        <div class="form-group">
            <label for="branch">Branch (opzionale)</label>
            <input type="text" id="branch" placeholder="main" value="main">
            <div class="hint">Lascia "main" se non sai cosa mettere</div>
        </div>

        <div class="form-group">
            <label for="filePath">Percorso file</label>
            <input type="text" id="filePath" value="assets/pdf/foglio_settimanale.pdf" readonly>
            <div class="hint">Il file sar√† caricato in questa posizione</div>
        </div>

        <button class="btn btn-secondary" id="saveConfigBtn">üíæ Salva Configurazione</button>
    </div>

    <div class="config-section" style="display: none;" id="commitSection">
        <h3>üí¨ Messaggio Commit</h3>

        <div class="form-group">
            <label for="commitMessage">Messaggio personalizzato</label>
            <input type="text" id="commitMessage" placeholder="es: Aggiornamento settimanale">
            <div class="hint">Lascia vuoto per usare il messaggio predefinito con data e ora</div>
        </div>
    </div>

    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <div class="upload-text">Clicca o trascina qui il PDF</div>
        <div class="upload-hint">Il file sar√† caricato in assets/pdf/foglio_settimanale.pdf</div>
    </div>

    <input type="file" id="fileInput" accept=".pdf">

    <div class="file-selected" id="fileSelected">
        <strong>File selezionato:</strong> <span id="selectedFileName"></span> (<span id="selectedFileSize"></span>)
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Caricamento in corso su GitHub...</div>
    </div>

    <button class="btn" id="uploadBtn" disabled>
        üöÄ Carica su GitHub
    </button>

    <button class="btn btn-secondary" id="viewOnGithubBtn" style="display: none;">
        üëÅÔ∏è Visualizza su GitHub
    </button>
</div>

<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const viewOnGithubBtn = document.getElementById('viewOnGithubBtn');
    const saveConfigBtn = document.getElementById('saveConfigBtn');
    const statusMessage = document.getElementById('statusMessage');
    const loading = document.getElementById('loading');
    const fileSelected = document.getElementById('fileSelected');
    const selectedFileName = document.getElementById('selectedFileName');
    const selectedFileSize = document.getElementById('selectedFileSize');

    const repoOwnerInput = document.getElementById('repoOwner');
    const repoNameInput = document.getElementById('repoName');
    const githubTokenInput = document.getElementById('githubToken');
    const branchInput = document.getElementById('branch');
    const filePathInput = document.getElementById('filePath');
    const commitMessageInput = document.getElementById('commitMessage');
    const commitSection = document.getElementById('commitSection');

    const FILE_PATH = 'assets/pdf/foglio_settimanale.pdf';

    let selectedFile = null;
    let config = {};

    // Carica configurazione salvata
    loadConfig();

    // Salva configurazione
    saveConfigBtn.addEventListener('click', () => {
        config = {
            owner: repoOwnerInput.value.trim(),
            repo: repoNameInput.value.trim(),
            token: githubTokenInput.value.trim(),
            branch: branchInput.value.trim() || 'main'
        };

        if (!config.owner || !config.repo || !config.token) {
            showMessage('Compila tutti i campi obbligatori', 'error');
            return;
        }

        localStorage.setItem('github_config', JSON.stringify(config));
        showMessage('‚úÖ Configurazione salvata!', 'success');
        checkUploadReady();
    });

    // Click sull'area di upload
    uploadArea.addEventListener('click', () => {
        if (!isConfigValid()) {
            showMessage('Prima configura i dati di GitHub', 'error');
            return;
        }
        fileInput.click();
    });

    // Selezione file
    fileInput.addEventListener('change', (e) => {
        handleFileSelect(e.target.files[0]);
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (isConfigValid()) {
            uploadArea.classList.add('dragover');
        }
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (!isConfigValid()) {
            showMessage('Prima configura i dati di GitHub', 'error');
            return;
        }
        handleFileSelect(e.dataTransfer.files[0]);
    });

    // Upload button
    uploadBtn.addEventListener('click', () => {
        uploadToGitHub();
    });

    // View on GitHub button
    viewOnGithubBtn.addEventListener('click', () => {
        const url = `https://github.com/${config.owner}/${config.repo}/blob/${config.branch}/${FILE_PATH}`;
        window.open(url, '_blank');
    });

    function loadConfig() {
        const saved = localStorage.getItem('github_config');
        if (saved) {
            config = JSON.parse(saved);
            repoOwnerInput.value = config.owner || '';
            repoNameInput.value = config.repo || '';
            githubTokenInput.value = config.token || '';
            branchInput.value = config.branch || 'main';
            checkUploadReady();
        }
    }

    function isConfigValid() {
        return config.owner && config.repo && config.token;
    }

    function checkUploadReady() {
        if (isConfigValid() && selectedFile) {
            uploadBtn.disabled = false;
        } else {
            uploadBtn.disabled = true;
        }

        if (!isConfigValid()) {
            uploadArea.classList.add('disabled');
        } else {
            uploadArea.classList.remove('disabled');
        }
    }

    function handleFileSelect(file) {
        if (!file) return;

        if (file.type !== 'application/pdf') {
            showMessage('Errore: Seleziona un file PDF valido', 'error');
            return;
        }

        selectedFile = file;
        selectedFileName.textContent = file.name;
        selectedFileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';
        fileSelected.classList.add('show');
        commitSection.style.display = 'block';
        showMessage('File selezionato. Clicca "Carica su GitHub" per pubblicare.', 'success');
        checkUploadReady();
    }

    async function uploadToGitHub() {
        if (!selectedFile || !isConfigValid()) return;

        loading.style.display = 'block';
        uploadBtn.disabled = true;
        statusMessage.style.display = 'none';

        try {
            // Converti il file in base64
            const base64Content = await fileToBase64(selectedFile);

            // Verifica se il file esiste gi√† (per ottenere lo SHA)
            let sha = null;
            try {
                const checkResponse = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${FILE_PATH}?ref=${config.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (checkResponse.ok) {
                    const data = await checkResponse.json();
                    sha = data.sha;
                }
            } catch (e) {
                // File non esiste, va bene cos√¨
            }

            // Carica o aggiorna il file
            const commitMsg = commitMessageInput.value.trim() ||
                `Aggiornamento foglio_settimanale.pdf - ${new Date().toLocaleString('it-IT')}`;

            const payload = {
                message: commitMsg,
                content: base64Content,
                branch: config.branch
            };

            if (sha) {
                payload.sha = sha;
            }

            const response = await fetch(
                `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${FILE_PATH}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Errore durante il caricamento');
            }

            const result = await response.json();

            showMessage('‚úÖ File caricato con successo su GitHub!', 'success');
            viewOnGithubBtn.style.display = 'block';

            // Reset
            selectedFile = null;
            fileInput.value = '';
            fileSelected.classList.remove('show');
            commitMessageInput.value = '';
            commitSection.style.display = 'none';

        } catch (error) {
            console.error('Errore:', error);
            showMessage(`‚ùå Errore: ${error.message}`, 'error');
        } finally {
            loading.style.display = 'none';
            checkUploadReady();
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                // Rimuovi il prefisso data:application/pdf;base64,
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function showMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;

        setTimeout(() => {
            if (type !== 'success') {
                statusMessage.style.display = 'none';
            }
        }, 5000);
    }
</script>
</body>
</html>